import httplib
import jarray
import base64
from java.io import File
from java.io import FileInputStream
import json

username = 'phanthao'
apiKey = 'da1fcf2b-2e15-42c4-ad20-3f7d59ffde3a'
base64EncodeBasicAuth = 'Basic ' + base64.b64encode(username + ":" + apiKey)

filename = "appdemo.apk"
filePath = "/Users/thaotphan/Downloads/appdemo.apk"

def generateUrl():
    header = {
        "Authorization": base64EncodeBasicAuth,
        "Accept": "application/json",
        "Content-Type": "application/json"
    }
    body = json.dumps({
        "filename": filename
    })
    conn = httplib.HTTPSConnection("api.kobiton.com")
    conn.request("POST","/v1/apps/uploadUrl",body,header)
    response = conn.getresponse()
    data = json.loads(response.read())
    return data.get("url"), data.get("appPath")

def uploadToS3(presignedUrl):
    header = {
    "Content-Type": "application/octet-stream",
    "x-amz-tagging": "unsaved=true"
    }
    stream = FileInputStream(File(filePath))
    file_bytes = jarray.zeros(stream.available(), "b")
    stream.read(file_bytes)
    conn = httplib.HTTPSConnection(presignedUrl)
    conn.request("PUT","/",file_bytes,header)
    response = conn.getresponse()
    stream.close()

def createApp(appPath):
    header = {
    "Authorization": base64EncodeBasicAuth,
    "Accept": "application/json",
    "Content-Type": "application/json"
    }
    body = json.dumps({
        "filename": filename,
        "appPath": appPath
    })
    conn = httplib.HTTPSConnection("api.kobiton.com")
    conn.request("POST","/v1/apps",body,header)
    response = conn.getresponse()
    data = json.loads(response.read())
    print data
    if data.get("appId"):
        return data.get("appId")
    else:
        return None
    
try:
    urlAppPath = generateUrl()
    uploadToS3(urlAppPath[0])
    appId = createApp(urlAppPath[1])
    if appId is not None:
        print "Your app is uploaded successfully. Your appID is", appId
    else:
        raise Exception("No AppID")
except Exception as ex:
    print ex
    print "Your app has not been uploaded. Please try again or upload manually on https://portal.kobiton.com/apps"
